generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model users {
  id             BigInt    @id @db.BigInt
  name           String    @db.VarChar(32)
  avatar         String    @db.VarChar(256)
  email          String    @db.VarChar(256)
  password       String    @db.VarChar(255)
  status         Int
  is_deleted     Boolean
  is_admin       Boolean   @default(false)
  credits        Int       @default(0)
  bio            String    @default("") @db.VarChar(500)
  website        String    @default("") @db.VarChar(256)
  location       String    @default("") @db.VarChar(100)
  birthday       DateTime?
  title_badge_id BigInt?   @db.BigInt
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  title_badge             badges?                @relation("user_title_badge", fields: [title_badge_id], references: [id])
  topics                  topics[]
  posts                   posts[]
  post_likes              post_likes[]           @relation("post_likes_user")
  post_bookmarks          post_bookmarks[]       @relation("post_bookmarks_user")
  user_badges             user_badges[]          @relation("user_badges_user")
  awarded_badges          user_badges[]          @relation("user_badges_awarder")
  followers               user_follows[]         @relation("user_follows_following")
  following               user_follows[]         @relation("user_follows_follower")
  conversations_initiated conversations[]        @relation("conversations_user1")
  conversations_received  conversations[]        @relation("conversations_user2")
  messages                messages[]             @relation("messages_sender")
  poll_votes              poll_votes[]           @relation("poll_votes_user")
  lottery_participants    lottery_participants[] @relation("lottery_participants_user")
  lottery_winners         lottery_winners[]      @relation("lottery_winners_user")
  bounty_rewards_given    bounty_rewards[]       @relation("bounty_rewards_giver")
  bounty_rewards_received bounty_rewards[]       @relation("bounty_rewards_receiver")
  question_acceptances    question_acceptances[] @relation("question_acceptances_accepter")
  checkins                user_checkins[]        @relation("user_checkins_user")
  credit_logs             user_credit_logs[]     @relation("user_credit_logs_user")
  donations               donations[]            @relation("donations_user")
  confirmed_donations     donations[]            @relation("donations_confirmer")

  notifications      notifications[] @relation("notifications_user")
  sent_notifications notifications[] @relation("notifications_sender")

  login_stats     user_login_stats?
  login_logs      user_login_logs[]
  uploads         uploads[]
  custom_status   user_custom_statuses?
  social_accounts user_social_accounts[] @relation("user_social_accounts_user")

  @@unique([email], map: "users_email_key")
  @@map("users")
}

model categories {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  icon          String   @db.VarChar(32)
  sort          Int      @default(0)
  bg_color      String?  @db.VarChar(16)
  text_color    String?  @db.VarChar(16)
  is_deleted    Boolean
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  topics       topics[]
  translations category_translations[]

  @@map("categories")
}

model category_translations {
  category_id BigInt   @db.BigInt
  locale      String   @db.VarChar(8)
  name        String   @db.VarChar(32)
  description String?  @db.VarChar(255)
  is_source   Boolean  @default(false)
  version     Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  category categories @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@id([category_id, locale])
  @@index([locale, is_source], map: "category_translations_locale_source_index")
  @@index([category_id, is_source], map: "category_translations_category_source_index")
  @@map("category_translations")
}

model tags {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  icon          String   @db.VarChar(32)
  sort          Int      @default(0)
  bg_color      String?  @db.VarChar(16)
  text_color    String?  @db.VarChar(16)
  is_deleted    Boolean
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  topic_links  topic_tags[]
  translations tag_translations[]

  @@map("tags")
}

model tag_translations {
  tag_id      BigInt   @db.BigInt
  locale      String   @db.VarChar(8)
  name        String   @db.VarChar(32)
  description String?  @db.VarChar(255)
  is_source   Boolean  @default(false)
  version     Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tag tags @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([tag_id, locale])
  @@index([locale, is_source], map: "tag_translations_locale_source_index")
  @@index([tag_id, is_source], map: "tag_translations_tag_source_index")
  @@map("tag_translations")
}

model topics {
  id            BigInt    @id @db.BigInt
  category_id   BigInt    @db.BigInt
  user_id       BigInt    @db.BigInt
  source_locale String    @default("zh") @db.VarChar(8)
  type          String    @default("GENERAL") @db.VarChar(32)
  status        String    @default("ACTIVE") @db.VarChar(32)
  end_time      DateTime?
  is_settled    Boolean   @default(false)
  views         Int       @default(0)
  is_pinned     Boolean   @default(false)
  is_community  Boolean   @default(false)
  is_deleted    Boolean
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  category             categories             @relation(fields: [category_id], references: [id])
  user                 users                  @relation(fields: [user_id], references: [id])
  posts                posts[]
  tag_links            topic_tags[]
  poll_options         poll_options[]
  poll_config          poll_configs?
  lottery_config       lottery_configs?
  lottery_participants lottery_participants[]
  lottery_winners      lottery_winners[]
  bounty_config        bounty_configs?
  bounty_rewards       bounty_rewards[]
  question_acceptance  question_acceptances?
  notifications        notifications[]
  translations         topic_translations[]

  @@index([user_id], map: "topics_user_index")
  @@index([category_id], map: "topics_category_index")
  @@index([type], map: "topics_type_index")
  @@index([status, end_time], map: "topics_status_endtime_index")
  @@index([type, status], map: "topics_type_status_index")
  @@index([is_settled], map: "topics_settled_index")
  @@map("topics")
}

model topic_translations {
  topic_id   BigInt   @db.BigInt
  locale     String   @db.VarChar(8)
  title      String   @db.VarChar(256)
  is_source  Boolean  @default(false)
  version    Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  topic topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@id([topic_id, locale])
  @@index([locale, is_source], map: "topic_translations_locale_source_index")
  @@index([topic_id, is_source], map: "topic_translations_topic_source_index")
  @@map("topic_translations")
}

model posts {
  id               BigInt   @id @db.BigInt
  topic_id         BigInt   @db.BigInt
  user_id          BigInt   @db.BigInt
  parent_id        BigInt   @default(0) @db.BigInt
  reply_to_user_id BigInt   @default(0) @db.BigInt
  floor_number     Int
  content          String   @db.Text
  source_locale    String   @default("zh") @db.VarChar(8)
  is_deleted       Boolean
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  topic               topics                @relation(fields: [topic_id], references: [id])
  user                users                 @relation(fields: [user_id], references: [id])
  likes               post_likes[]          @relation("post_likes_post")
  bookmarks           post_bookmarks[]      @relation("post_bookmarks_post")
  bounty_rewards      bounty_rewards[]
  lottery_winners     lottery_winners[]
  question_acceptance question_acceptances?
  notifications       notifications[]
  translations        post_translations[]

  @@index([topic_id], map: "posts_topic_index")
  @@index([user_id], map: "posts_user_index")
  @@map("posts")
}

model post_translations {
  post_id      BigInt   @db.BigInt
  locale       String   @db.VarChar(8)
  content_html String   @db.Text
  is_source    Boolean  @default(false)
  version      Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  post posts @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@id([post_id, locale])
  @@index([locale, is_source], map: "post_translations_locale_source_index")
  @@index([post_id, is_source], map: "post_translations_post_source_index")
  @@map("post_translations")
}

model topic_tags {
  topic_id   BigInt   @db.BigInt
  tag_id     BigInt   @db.BigInt
  created_at DateTime @default(now())

  topic topics @relation(fields: [topic_id], references: [id])
  tag   tags   @relation(fields: [tag_id], references: [id])

  @@id([topic_id, tag_id])
  @@index([tag_id], map: "topic_tags_tag_index")
  @@index([topic_id], map: "topic_tags_topic_index")
  @@map("topic_tags")
}

model post_likes {
  post_id    BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  created_at DateTime @default(now())

  post posts @relation("post_likes_post", fields: [post_id], references: [id])
  user users @relation("post_likes_user", fields: [user_id], references: [id])

  @@id([post_id, user_id])
  @@index([user_id], map: "post_likes_user_index")
  @@index([post_id], map: "post_likes_post_index")
  @@map("post_likes")
}

model post_bookmarks {
  post_id    BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  created_at DateTime @default(now())

  post posts @relation("post_bookmarks_post", fields: [post_id], references: [id])
  user users @relation("post_bookmarks_user", fields: [user_id], references: [id])

  @@id([post_id, user_id])
  @@index([user_id], map: "post_bookmarks_user_index")
  @@index([post_id], map: "post_bookmarks_post_index")
  @@map("post_bookmarks")
}

model badges {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  icon          String   @db.VarChar(32)
  badge_type    String   @db.VarChar(32)
  level         Int      @default(1)
  sort          Int      @default(0)
  bg_color      String?  @db.VarChar(16)
  text_color    String?  @db.VarChar(16)
  is_enabled    Boolean  @default(true)
  is_visible    Boolean  @default(true)
  is_deleted    Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user_badges      user_badges[]        @relation("user_badges_badge")
  users_with_title users[]              @relation("user_title_badge")
  translations     badge_translations[]

  @@index([badge_type], map: "badges_type_index")
  @@index([is_deleted, is_enabled], map: "badges_status_index")
  @@map("badges")
}

model badge_translations {
  badge_id    BigInt   @db.BigInt
  locale      String   @db.VarChar(8)
  name        String   @db.VarChar(32)
  description String?  @db.VarChar(255)
  is_source   Boolean  @default(false)
  version     Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  badge badges @relation(fields: [badge_id], references: [id], onDelete: Cascade)

  @@id([badge_id, locale])
  @@index([locale, is_source], map: "badge_translations_locale_source_index")
  @@index([badge_id, is_source], map: "badge_translations_badge_source_index")
  @@map("badge_translations")
}

model user_badges {
  user_id    BigInt   @db.BigInt
  badge_id   BigInt   @db.BigInt
  awarded_at DateTime @default(now())
  awarded_by BigInt?  @db.BigInt
  is_deleted Boolean  @default(false)

  user    users  @relation("user_badges_user", fields: [user_id], references: [id])
  badge   badges @relation("user_badges_badge", fields: [badge_id], references: [id])
  awarder users? @relation("user_badges_awarder", fields: [awarded_by], references: [id])

  @@id([user_id, badge_id])
  @@index([user_id, is_deleted], map: "user_badges_user_index")
  @@index([badge_id, is_deleted], map: "user_badges_badge_index")
  @@index([is_deleted], map: "user_badges_deleted_index")
  @@map("user_badges")
}

model system_configs {
  id            BigInt   @id @db.BigInt
  config_key    String   @unique @db.VarChar(64)
  config_value  String   @db.Text
  config_type   String   @db.VarChar(16)
  category      String   @db.VarChar(32)
  description   String?  @db.VarChar(255)
  is_public     Boolean  @default(false)
  is_sensitive  Boolean  @default(false)
  default_value String   @db.Text
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([category], map: "system_configs_category_index")
  @@index([is_public], map: "system_configs_public_index")
  @@map("system_configs")
}

model user_follows {
  follower_id  BigInt   @db.BigInt
  following_id BigInt   @db.BigInt
  created_at   DateTime @default(now())

  follower  users @relation("user_follows_follower", fields: [follower_id], references: [id])
  following users @relation("user_follows_following", fields: [following_id], references: [id])

  @@id([follower_id, following_id])
  @@index([follower_id], map: "user_follows_follower_index")
  @@index([following_id], map: "user_follows_following_index")
  @@map("user_follows")
}

model conversations {
  id         BigInt   @id @db.BigInt
  user1_id   BigInt   @db.BigInt
  user2_id   BigInt   @db.BigInt
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user1    users      @relation("conversations_user1", fields: [user1_id], references: [id])
  user2    users      @relation("conversations_user2", fields: [user2_id], references: [id])
  messages messages[] @relation("messages_conversation")

  @@index([user1_id], map: "conversations_user1_index")
  @@index([user2_id], map: "conversations_user2_index")
  @@index([user1_id, user2_id], map: "conversations_users_index")
  @@map("conversations")
}

model messages {
  id              BigInt   @id @db.BigInt
  conversation_id BigInt   @db.BigInt
  sender_id       BigInt   @db.BigInt
  content         String   @db.Text
  is_read         Boolean  @default(false)
  is_deleted      Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  conversation conversations @relation("messages_conversation", fields: [conversation_id], references: [id])
  sender       users         @relation("messages_sender", fields: [sender_id], references: [id])

  @@index([conversation_id], map: "messages_conversation_index")
  @@index([sender_id], map: "messages_sender_index")
  @@index([is_read], map: "messages_read_index")
  @@map("messages")
}

model poll_options {
  id          BigInt   @id @db.BigInt
  topic_id    BigInt   @db.BigInt
  option_text String   @db.VarChar(256)
  sort        Int
  is_deleted  Boolean  @default(false)
  created_at  DateTime @default(now())

  topic topics       @relation(fields: [topic_id], references: [id])
  votes poll_votes[]

  @@index([topic_id], map: "poll_options_topic_index")
  @@map("poll_options")
}

model poll_votes {
  option_id  BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  created_at DateTime @default(now())

  option poll_options @relation(fields: [option_id], references: [id])
  user   users        @relation("poll_votes_user", fields: [user_id], references: [id])

  @@id([option_id, user_id])
  @@index([option_id], map: "poll_votes_option_index")
  @@index([user_id], map: "poll_votes_user_index")
  @@map("poll_votes")
}

model lottery_participants {
  topic_id   BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  is_winner  Boolean  @default(false)
  created_at DateTime @default(now())

  topic topics @relation(fields: [topic_id], references: [id])
  user  users  @relation("lottery_participants_user", fields: [user_id], references: [id])

  @@id([topic_id, user_id])
  @@index([topic_id], map: "lottery_participants_topic_index")
  @@index([user_id], map: "lottery_participants_user_index")
  @@index([is_winner], map: "lottery_participants_winner_index")
  @@map("lottery_participants")
}

model poll_configs {
  topic_id                 BigInt   @id @db.BigInt
  allow_multiple           Boolean  @default(false)
  max_choices              Int?
  show_results_before_vote Boolean  @default(false)
  show_voter_list          Boolean  @default(false)
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  topic topics @relation(fields: [topic_id], references: [id])

  @@index([topic_id], map: "poll_configs_topic_index")
  @@map("poll_configs")
}

model lottery_configs {
  topic_id              BigInt    @id @db.BigInt
  draw_type             String    @db.VarChar(32)
  end_time              DateTime?
  participant_threshold Int?
  algorithm_type        String    @db.VarChar(32)
  floor_interval        Int?
  fixed_floors          String?   @db.VarChar(500)
  winner_count          Int?
  entry_cost            Int       @default(0)
  is_drawn              Boolean   @default(false)
  drawn_at              DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  topic topics @relation(fields: [topic_id], references: [id])

  @@index([draw_type], map: "lottery_configs_drawtype_index")
  @@index([is_drawn], map: "lottery_configs_drawn_index")
  @@index([end_time], map: "lottery_configs_endtime_index")
  @@index([draw_type, is_drawn], map: "lottery_configs_type_drawn_index")
  @@map("lottery_configs")
}

model lottery_winners {
  id           BigInt   @id @db.BigInt
  topic_id     BigInt   @db.BigInt
  post_id      BigInt   @db.BigInt
  user_id      BigInt   @db.BigInt
  floor_number Int
  won_at       DateTime @default(now())
  created_at   DateTime @default(now())

  topic topics @relation(fields: [topic_id], references: [id])
  post  posts  @relation(fields: [post_id], references: [id])
  user  users  @relation("lottery_winners_user", fields: [user_id], references: [id])

  @@unique([topic_id, post_id], map: "lottery_winners_topic_post_unique")
  @@unique([topic_id, user_id], map: "lottery_winners_topic_user_unique")
  @@index([topic_id], map: "lottery_winners_topic_index")
  @@index([user_id], map: "lottery_winners_user_index")
  @@index([won_at], map: "lottery_winners_wonat_index")
  @@map("lottery_winners")
}

model bounty_configs {
  topic_id        BigInt   @id @db.BigInt
  bounty_total    Int
  bounty_type     String   @db.VarChar(32)
  bounty_slots    Int
  remaining_slots Int
  single_amount   Int?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  topic topics @relation(fields: [topic_id], references: [id])

  @@index([bounty_type], map: "bounty_configs_type_index")
  @@map("bounty_configs")
}

model bounty_rewards {
  id          BigInt   @id @db.BigInt
  topic_id    BigInt   @db.BigInt
  post_id     BigInt   @db.BigInt
  giver_id    BigInt   @db.BigInt
  receiver_id BigInt   @db.BigInt
  amount      Int
  created_at  DateTime @default(now())

  topic    topics @relation(fields: [topic_id], references: [id])
  post     posts  @relation(fields: [post_id], references: [id])
  giver    users  @relation("bounty_rewards_giver", fields: [giver_id], references: [id])
  receiver users  @relation("bounty_rewards_receiver", fields: [receiver_id], references: [id])

  @@unique([topic_id, receiver_id], map: "bounty_rewards_topic_receiver_unique")
  @@index([topic_id], map: "bounty_rewards_topic_index")
  @@index([receiver_id], map: "bounty_rewards_receiver_index")
  @@index([giver_id], map: "bounty_rewards_giver_index")
  @@map("bounty_rewards")
}

model question_acceptances {
  topic_id    BigInt   @id @db.BigInt
  post_id     BigInt   @unique @db.BigInt
  accepted_by BigInt   @db.BigInt
  accepted_at DateTime @default(now())
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  topic    topics @relation(fields: [topic_id], references: [id])
  post     posts  @relation(fields: [post_id], references: [id])
  accepter users  @relation("question_acceptances_accepter", fields: [accepted_by], references: [id])

  @@index([post_id], map: "question_acceptances_post_index")
  @@index([accepted_by], map: "question_acceptances_accepter_index")
  @@map("question_acceptances")
}

model user_checkins {
  id             BigInt   @id @db.BigInt
  user_id        BigInt   @db.BigInt
  checkin_date   DateTime @db.Date
  credits_earned Int      @default(0)
  created_at     DateTime @default(now())

  user users @relation("user_checkins_user", fields: [user_id], references: [id])

  @@unique([user_id, checkin_date], map: "user_checkins_user_date_unique")
  @@index([user_id], map: "user_checkins_user_index")
  @@index([checkin_date], map: "user_checkins_date_index")
  @@index([created_at], map: "user_checkins_created_index")
  @@map("user_checkins")
}

model user_login_stats {
  user_id                BigInt   @id @db.BigInt
  last_login_at          DateTime @default(now())
  last_login_ip          String   @db.VarChar(64)
  consecutive_login_days Int      @default(0)
  total_login_days       Int      @default(1)
  location_lat           String?  @db.VarChar(32)
  location_long          String?  @db.VarChar(32)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_login_stats")
}

model user_login_logs {
  id            BigInt   @id @db.BigInt
  user_id       BigInt   @db.BigInt
  ip            String   @db.VarChar(64)
  user_agent    String?  @db.VarChar(512)
  location_lat  String?  @db.VarChar(32)
  location_long String?  @db.VarChar(32)
  status        String   @db.VarChar(16) // SUCCESS, FAILED
  login_method  String   @db.VarChar(32) // FORM, GITHUB, GOOGLE, LINUXDO, etc.
  login_at      DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "user_login_logs_user_index")
  @@index([login_at], map: "user_login_logs_time_index")
  @@index([status], map: "user_login_logs_status_index")
  @@map("user_login_logs")
}

enum CreditLogType {
  CHECKIN
  POST_REWARD
  BOUNTY_RECEIVED
  BOUNTY_GIVEN
  LOTTERY_ENTRY
  ADMIN_ADJUSTMENT
  OTHER
}

// 捐赠来源类型
enum DonationSource {
  KOFI // Ko-fi 平台
  PATREON // Patreon 平台
  PAYPAL // PayPal 直接捐赠
  ALIPAY // 支付宝
  WECHAT_PAY // 微信支付
  BANK_TRANSFER // 银行转账/线下转账
  CRYPTO // 加密货币
  OTHER // 其它来源
}

// 捐赠状态
enum DonationStatus {
  PENDING // 待确认（线下转账等需要人工确认）
  CONFIRMED // 已确认
  FAILED // 失败/无效
  REFUNDED // 已退款
  CANCELLED // 已取消
}

model user_credit_logs {
  id          BigInt        @id @db.BigInt
  user_id     BigInt        @db.BigInt
  amount      Int
  balance     Int
  type        CreditLogType
  description String        @default("") @db.VarChar(256)
  created_at  DateTime      @default(now())

  user users @relation("user_credit_logs_user", fields: [user_id], references: [id])

  @@index([user_id], map: "user_credit_logs_user_index")
  @@index([type], map: "user_credit_logs_type_index")
  @@index([created_at], map: "user_credit_logs_created_index")
  @@map("user_credit_logs")
}

// 捐赠记录表
model donations {
  id BigInt @id @db.BigInt

  // 捐赠用户（可为空，支持非注册用户捐赠）
  user_id BigInt? @db.BigInt

  // 金额相关
  amount   Decimal @db.Decimal(10, 2) // 捐赠金额，支持小数
  currency String  @default("CNY") @db.VarChar(8) // 货币类型：CNY, USD, EUR 等

  // 来源区分
  source DonationSource // 捐赠来源

  // 状态
  status DonationStatus @default(PENDING)

  // 外部关联ID（用于对接第三方平台的交易ID）
  external_id String? @db.VarChar(128)

  // 是否匿名捐赠
  is_anonymous Boolean @default(false)

  // 捐赠者显示名称（用于非注册用户或匿名用户的展示名）
  donor_name String? @db.VarChar(64)

  // 捐赠者邮箱（用于非注册用户联系或发送感谢）
  donor_email String? @db.VarChar(256)

  // 捐赠留言
  message String? @db.VarChar(500)

  // 管理员备注（仅管理员可见）
  admin_note String? @db.VarChar(500)

  // 确认信息
  confirmed_by BigInt?   @db.BigInt // 确认人（管理员）
  confirmed_at DateTime? // 确认时间

  // 通用字段
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // 关联关系
  user      users? @relation("donations_user", fields: [user_id], references: [id])
  confirmer users? @relation("donations_confirmer", fields: [confirmed_by], references: [id])

  @@index([user_id], map: "donations_user_index")
  @@index([source], map: "donations_source_index")
  @@index([status], map: "donations_status_index")
  @@index([external_id], map: "donations_external_index")
  @@index([is_anonymous], map: "donations_anonymous_index")
  @@index([created_at], map: "donations_created_index")
  @@index([status, source], map: "donations_status_source_index")
  @@map("donations")
}

// ==================== 自动化规则系统 ====================

// 触发器类型枚举
enum RuleTriggerType {
  CRON // 定时任务
  POST_CREATE // 发帖
  POST_REPLY // 回帖
  CHECKIN // 签到
  DONATION // 捐赠
  POST_LIKE_GIVEN // 送出的赞
  POST_LIKE_RECEIVED // 收到的赞
  USER_REGISTER // 注册
  USER_LOGIN // 登录
}

// 执行动作类型枚举
enum RuleActionType {
  CREDIT_CHANGE // 积分变动
  BADGE_GRANT // 授予徽章
  BADGE_REVOKE // 撤销徽章
  USER_GROUP_CHANGE // 用户组变更（预留）
}

// 自动化规则表
model automation_rules {
  id BigInt @id @db.BigInt

  // 规则基本信息
  name        String  @db.VarChar(128) // 规则名称
  description String? @db.VarChar(512) // 规则描述

  // 触发器配置
  trigger_type       RuleTriggerType // 触发器类型
  trigger_conditions Json? // 触发条件（JSON格式存储动态配置）
  // 示例:
  // CRON: {"cron": "0 0 * * *", "timezone": "Asia/Shanghai"}
  // POST_CREATE: {"category_ids": [1,2,3], "min_content_length": 100}
  // POST_REPLY: {"topic_type": "BOUNTY", "is_first_reply": true}
  // CHECKIN: {"consecutive_days": 7}
  // DONATION: {"min_amount": 100, "currency": "CNY", "sources": ["ALIPAY", "WECHAT_PAY"]}
  // POST_LIKE_GIVEN: {"min_count": 10}
  //   - min_count: 用户送出的赞达到此数量才触发
  // POST_LIKE_RECEIVED: {"min_count": 10}
  //   - min_count: 用户收到的赞达到此数量才触发
  // USER_REGISTER: {"oauth_provider": "github"}
  // USER_LOGIN: {"consecutive_days": 30}

  // 执行动作配置（支持多个动作）
  actions Json // 动作列表（JSON数组格式）
  // 示例:
  // [
  //   {"type": "CREDIT_CHANGE", "params": {"amount": 10, "description": "每日签到奖励"}},
  //   {"type": "BADGE_GRANT", "params": {"badge_id": 5, "auto_grant": true}},
  //   {"type": "BADGE_REVOKE", "params": {"badge_id": 3, "reason": "条件不满足"}}
  // ]
  // 每个 action 对象包含:
  // - type: 动作类型字符串 ("CREDIT_CHANGE" | "BADGE_GRANT" | "BADGE_REVOKE" | "USER_GROUP_CHANGE")
  // - params: 动作参数对象

  // 规则控制
  priority         Int     @default(0) // 优先级（数字越大优先级越高）
  is_enabled       Boolean @default(true) // 是否启用
  is_repeatable    Boolean @default(true) // 是否可重复触发
  max_executions   Int? // 最大执行次数（null表示无限制）
  cooldown_seconds Int? // 冷却时间（秒）

  // 时间限制
  start_time DateTime? // 规则生效开始时间
  end_time   DateTime? // 规则生效结束时间

  // 审计字段
  created_by BigInt?  @db.BigInt // 创建人（管理员ID）
  updated_by BigInt?  @db.BigInt // 最后更新人
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // 关联关系
  execution_logs automation_rule_logs[]

  @@index([trigger_type], map: "automation_rules_trigger_index")
  @@index([is_enabled, is_deleted], map: "automation_rules_status_index")
  @@index([trigger_type, is_enabled], map: "automation_rules_trigger_enabled_index")
  @@index([priority], map: "automation_rules_priority_index")
  @@index([start_time, end_time], map: "automation_rules_time_range_index")
  @@map("automation_rules")
}

// 规则执行日志表
model automation_rule_logs {
  id BigInt @id @db.BigInt

  // 关联规则
  rule_id BigInt @db.BigInt

  // 触发信息
  triggered_by    BigInt? @db.BigInt // 触发用户ID(可为空,如定时任务)
  target_user_id  BigInt? @db.BigInt // 执行对象的用户ID(如授予徽章的目标用户)
  trigger_context Json? // 触发上下文数据
  // 示例:
  // {"topic_id": 123, "post_id": 456, "category_id": 1}
  // {"donation_id": 789, "amount": 500}
  // {"checkin_id": 111, "consecutive_days": 7}

  // 执行结果
  execution_status String @db.VarChar(32) // SUCCESS, FAILED, SKIPPED (按优先级: FAILED > SKIPPED > SUCCESS)
  execution_result Json? // 执行结果详情(聚合所有动作的结果)
  // 格式示例(一次规则执行记录一条日志，包含所有动作结果):
  // [
  //   {"actionType": "CREDIT_CHANGE", "status": "SUCCESS", "data": {"credit_changed": 10, "new_balance": 1000}},
  //   {"actionType": "BADGE_GRANT", "status": "SKIPPED", "message": "Automation.skipReason.badgeAlreadyOwned", "messageParams": {"badgeName": "活跃用户"}}
  // ]
  // 每个 actionResult 包含:
  // - actionType: RuleActionType 枚举值
  // - status: 动作执行状态 (SUCCESS/FAILED/SKIPPED)
  // - data: 成功执行的数据
  // - message: 失败/跳过的多语言键值
  // - messageParams: 失败/跳过消息的参数

  error_message String? @db.Text // 错误信息（如果失败）

  // 执行时间
  executed_at DateTime @default(now())
  created_at  DateTime @default(now())

  // 关联关系
  rule automation_rules @relation(fields: [rule_id], references: [id])

  @@index([rule_id], map: "automation_logs_rule_index")
  @@index([triggered_by], map: "automation_logs_user_index")
  @@index([target_user_id], map: "automation_logs_target_index")
  @@index([execution_status], map: "automation_logs_status_index")
  @@index([executed_at], map: "automation_logs_executed_index")
  @@index([rule_id, execution_status], map: "automation_logs_rule_status_index")
  @@index([rule_id, target_user_id], map: "automation_logs_rule_target_index") // 优化：支持不可重复检查
  @@index([rule_id, target_user_id, execution_status], map: "automation_logs_rule_target_status_index")
  @@index([triggered_by, executed_at], map: "automation_logs_user_time_index")
  @@map("automation_rule_logs")
}

// ==================== 翻译任务系统 ====================

// 翻译实体类型枚举
enum TranslationEntityType {
  CATEGORY // 分类
  TAG // 标签
  BADGE // 徽章
  TOPIC // 话题
  POST // 帖子
}

// 翻译任务状态枚举
enum TranslationTaskStatus {
  PENDING // 待处理
  PROCESSING // 处理中
  COMPLETED // 已完成
  FAILED // 失败
  CANCELLED // 已取消
}

// 翻译任务优先级枚举
enum TranslationTaskPriority {
  LOWEST // 最低优先级
  LOW // 低优先级
  NORMAL // 普通优先级
  HIGH // 高优先级
  URGENT // 紧急优先级
}

// 翻译任务表
model translation_tasks {
  id BigInt @id @db.BigInt

  // 目标实体信息
  entity_type TranslationEntityType // 实体类型
  entity_id   BigInt                @db.BigInt // 目标实体ID

  // 翻译配置
  source_locale  String @db.VarChar(8) // 源语言代码
  target_locale  String @db.VarChar(8) // 目标语言代码
  source_version Int    @default(1) // 源内容版本号

  // 任务状态
  status   TranslationTaskStatus   @default(PENDING) // 任务状态
  priority TranslationTaskPriority @default(NORMAL) // 任务优先级

  // 重试机制
  retry_count   Int     @default(0) // 重试次数
  error_message String? @db.Text // 错误信息

  // 时间追踪
  started_at   DateTime? // 开始处理时间
  completed_at DateTime? // 完成时间
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  // 复合索引：按状态和优先级查询待处理任务(用于任务队列)
  @@index([status, priority], map: "translation_tasks_status_priority_index")
  // 复合索引：查询特定实体的所有翻译任务
  @@index([entity_type, entity_id], map: "translation_tasks_entity_index")
  // 复合索引：查询特定实体和语言的任务(避免重复创建)
  @@index([entity_type, entity_id, target_locale], map: "translation_tasks_entity_locale_index")
  @@map("translation_tasks")
}

enum NotificationType {
  SYSTEM // System announcement
  TOPIC_REPLY // Someone replied to your topic
  POST_REPLY // Someone replied to your post
  MENTION // Someone @mentioned you
  LIKE // Someone liked your post
  BADGE_AWARD // You received a badge
  BOUNTY_REWARD // You received a bounty reward
  LOTTERY_WIN // You won a lottery
}

model notifications {
  id         BigInt           @id @db.BigInt
  user_id    BigInt           @db.BigInt // Recipient
  sender_id  BigInt           @db.BigInt // Triggered by (e.g., the person who replied)
  type       NotificationType
  read       Boolean          @default(false)
  is_deleted Boolean          @default(false)

  // Context References
  topic_id BigInt? @db.BigInt
  post_id  BigInt? @db.BigInt

  // Flexible data for other types (e.g., badge_id, system message content)
  data Json?

  created_at DateTime @default(now())

  // Relations
  user   users   @relation("notifications_user", fields: [user_id], references: [id])
  sender users?  @relation("notifications_sender", fields: [sender_id], references: [id])
  topic  topics? @relation(fields: [topic_id], references: [id])
  post   posts?  @relation(fields: [post_id], references: [id])

  // Indexes for performance
  @@index([user_id], map: "notifications_user_index")
  @@index([read], map: "notifications_read_index")
  @@index([type], map: "notifications_type_index")
  @@index([created_at], map: "notifications_created_index")
  // Composite index for fetching unread notifications efficiently
  @@index([user_id, read, created_at], map: "notifications_user_read_created_index")
  @@map("notifications")
}

model uploads {
  id           BigInt   @id @db.BigInt
  user_id      BigInt   @db.BigInt
  url          String   @db.VarChar(255)
  pathname     String   @db.VarChar(255)
  content_type String   @db.VarChar(64)
  size         Int
  created_at   DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id], map: "uploads_user_index")
  @@index([created_at], map: "uploads_created_index")
  @@map("uploads")
}

enum LLMInterfaceMode {
  OPENAI
  GEMINI
  DEEPSEEK
  ANTHROPIC
  GROK
}

enum LLMUsage {
  TRANSLATION
  CHAT
  SUMMARIZATION
}

model llm_configs {
  id             BigInt           @id @default(autoincrement()) @db.BigInt
  interface_mode LLMInterfaceMode
  name           String           @db.VarChar(100)
  base_url       String?          @db.VarChar(255)
  api_key        String           @db.VarChar(255)
  usage          LLMUsage         @unique
  is_enabled     Boolean          @default(true)
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @updatedAt @db.Timestamptz(6)
}

// 用户自定义状态表
model user_custom_statuses {
  user_id     BigInt    @id @db.BigInt // 用户ID,作为主键保证一对一关系
  emoji       String?   @db.VarChar(16) // emoji 表情(可为空,支持仅文本状态)
  status_text String    @db.VarChar(100) // 状态描述文本
  expires_at  DateTime? // 自动移除状态的时间(可为空,表示永不过期)
  is_deleted  Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  // 关联关系
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at], map: "user_custom_statuses_expires_index") // 用于定时清理过期状态
  @@index([is_deleted], map: "user_custom_statuses_deleted_index")
  @@map("user_custom_statuses")
}

model social_providers {
  id             BigInt   @id @db.BigInt
  provider_key   String   @unique @db.VarChar(32)
  name           String   @db.VarChar(64)
  client_id      String   @db.VarChar(256)
  client_secret  String   @db.VarChar(256)
  authorize_url  String?  @db.VarChar(512)
  token_url      String?  @db.VarChar(512)
  userinfo_url   String?  @db.VarChar(512)
  well_known_url String?  @db.VarChar(512)
  scope          String?  @db.VarChar(256)
  icon           String?  @db.VarChar(512)
  sort           Int      @default(0)
  is_enabled     Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user_accounts user_social_accounts[] @relation("user_social_accounts_provider")

  @@index([is_enabled], map: "social_providers_enabled_index")
  @@map("social_providers")
}

model user_social_accounts {
  id                BigInt    @id @db.BigInt
  user_id           BigInt    @db.BigInt
  provider_key      String    @db.VarChar(32)
  provider_uid      String    @db.VarChar(128)
  provider_username String?   @db.VarChar(128)
  provider_email    String?   @db.VarChar(256)
  provider_avatar   String?   @db.VarChar(512)
  access_token      String?   @db.VarChar(2048)
  refresh_token     String?   @db.VarChar(2048)
  token_expires_at  DateTime?
  extra_data        Json?
  last_used_at      DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  user     users            @relation("user_social_accounts_user", fields: [user_id], references: [id])
  provider social_providers @relation("user_social_accounts_provider", fields: [provider_key], references: [provider_key])

  @@unique([provider_key, provider_uid], map: "user_social_accounts_provider_uid_unique")
  @@index([user_id], map: "user_social_accounts_user_index")
  @@index([provider_key], map: "user_social_accounts_provider_index")
  @@map("user_social_accounts")
}
