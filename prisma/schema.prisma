generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model users {
  id             BigInt    @id @db.BigInt
  name           String    @db.VarChar(32)
  avatar         String    @db.VarChar(256)
  email          String    @db.VarChar(256)
  password       String?   @db.VarChar(255)
  status         Int
  is_deleted     Boolean
  is_admin       Boolean   @default(false)
  credits        Int       @default(0)
  bio            String    @default("") @db.VarChar(500)
  website        String    @default("") @db.VarChar(256)
  location       String    @default("") @db.VarChar(100)
  birthday       DateTime?
  title_badge_id BigInt?   @db.BigInt
  created_at     DateTime  @default(now())
  updated_at     DateTime  @updatedAt

  title_badge             badges?                @relation("user_title_badge", fields: [title_badge_id], references: [id])
  topics                  topics[]
  posts                   posts[]
  post_likes              post_likes[]           @relation("post_likes_user")
  post_bookmarks          post_bookmarks[]       @relation("post_bookmarks_user")
  user_badges             user_badges[]          @relation("user_badges_user")
  awarded_badges          user_badges[]          @relation("user_badges_awarder")
  followers               user_follows[]         @relation("user_follows_following")
  following               user_follows[]         @relation("user_follows_follower")
  conversations_initiated conversations[]        @relation("conversations_user1")
  conversations_received  conversations[]        @relation("conversations_user2")
  messages                messages[]             @relation("messages_sender")
  poll_votes              poll_votes[]           @relation("poll_votes_user")
  lottery_participants    lottery_participants[] @relation("lottery_participants_user")
  lottery_winners         lottery_winners[]      @relation("lottery_winners_user")
  bounty_rewards_given    bounty_rewards[]       @relation("bounty_rewards_giver")
  bounty_rewards_received bounty_rewards[]       @relation("bounty_rewards_receiver")
  question_acceptances    question_acceptances[] @relation("question_acceptances_accepter")
  checkins                user_checkins[]        @relation("user_checkins_user")
  credit_logs             user_credit_logs[]     @relation("user_credit_logs_user")
  donations               donations[]            @relation("donations_user")
  confirmed_donations     donations[]            @relation("donations_confirmer")

  notifications      notifications[] @relation("notifications_user")
  sent_notifications notifications[] @relation("notifications_sender")

  login_stats     user_login_stats?
  login_logs      user_login_logs[]
  uploads         uploads[]
  custom_status   user_custom_statuses?
  social_accounts user_social_accounts[] @relation("user_social_accounts_user")
  two_factor      user_two_factor?
  storage_files   storage_files[]        @relation("storage_files_user")

  @@unique([email], map: "users_email_key")
  @@map("users")
}

model categories {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  icon          String   @db.VarChar(32)
  sort          Int      @default(0)
  bg_color      String?  @db.VarChar(16)
  text_color    String?  @db.VarChar(16)
  is_deleted    Boolean
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  topics       topics[]
  translations category_translations[]

  @@map("categories")
}

model category_translations {
  category_id BigInt   @db.BigInt
  locale      String   @db.VarChar(8)
  name        String   @db.VarChar(32)
  description String?  @db.VarChar(255)
  is_source   Boolean  @default(false)
  version     Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  category categories @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@id([category_id, locale])
  @@index([locale, is_source], map: "category_translations_locale_source_index")
  @@index([category_id, is_source], map: "category_translations_category_source_index")
  @@map("category_translations")
}

model tags {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  icon          String   @db.VarChar(32)
  sort          Int      @default(0)
  bg_color      String?  @db.VarChar(16)
  text_color    String?  @db.VarChar(16)
  is_deleted    Boolean
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  topic_links  topic_tags[]
  translations tag_translations[]

  @@map("tags")
}

model tag_translations {
  tag_id      BigInt   @db.BigInt
  locale      String   @db.VarChar(8)
  name        String   @db.VarChar(32)
  description String?  @db.VarChar(255)
  is_source   Boolean  @default(false)
  version     Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  tag tags @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([tag_id, locale])
  @@index([locale, is_source], map: "tag_translations_locale_source_index")
  @@index([tag_id, is_source], map: "tag_translations_tag_source_index")
  @@map("tag_translations")
}

model topics {
  id            BigInt    @id @db.BigInt
  category_id   BigInt    @db.BigInt
  user_id       BigInt    @db.BigInt
  source_locale String    @default("zh") @db.VarChar(8)
  type          String    @default("GENERAL") @db.VarChar(32)
  status        String    @default("ACTIVE") @db.VarChar(32)
  end_time      DateTime?
  is_settled    Boolean   @default(false)
  views         Int       @default(0)
  is_pinned     Boolean   @default(false)
  is_community  Boolean   @default(false)
  is_deleted    Boolean
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  category             categories             @relation(fields: [category_id], references: [id])
  user                 users                  @relation(fields: [user_id], references: [id])
  posts                posts[]
  tag_links            topic_tags[]
  poll_options         poll_options[]
  poll_config          poll_configs?
  lottery_config       lottery_configs?
  lottery_participants lottery_participants[]
  lottery_winners      lottery_winners[]
  bounty_config        bounty_configs?
  bounty_rewards       bounty_rewards[]
  question_acceptance  question_acceptances?
  notifications        notifications[]
  translations         topic_translations[]

  @@index([user_id], map: "topics_user_index")
  @@index([category_id], map: "topics_category_index")
  @@index([type], map: "topics_type_index")
  @@index([status, end_time], map: "topics_status_endtime_index")
  @@index([type, status], map: "topics_type_status_index")
  @@index([is_settled], map: "topics_settled_index")
  @@map("topics")
}

model topic_translations {
  topic_id   BigInt   @db.BigInt
  locale     String   @db.VarChar(8)
  title      String   @db.VarChar(256)
  is_source  Boolean  @default(false)
  version    Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  topic topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@id([topic_id, locale])
  @@index([locale, is_source], map: "topic_translations_locale_source_index")
  @@index([topic_id, is_source], map: "topic_translations_topic_source_index")
  @@map("topic_translations")
}

model posts {
  id               BigInt   @id @db.BigInt
  topic_id         BigInt   @db.BigInt
  user_id          BigInt   @db.BigInt
  parent_id        BigInt   @default(0) @db.BigInt
  reply_to_user_id BigInt   @default(0) @db.BigInt
  floor_number     Int
  content          String   @db.Text
  source_locale    String   @default("zh") @db.VarChar(8)
  is_deleted       Boolean
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  topic               topics                @relation(fields: [topic_id], references: [id])
  user                users                 @relation(fields: [user_id], references: [id])
  likes               post_likes[]          @relation("post_likes_post")
  bookmarks           post_bookmarks[]      @relation("post_bookmarks_post")
  bounty_rewards      bounty_rewards[]
  lottery_winners     lottery_winners[]
  question_acceptance question_acceptances?
  notifications       notifications[]
  translations        post_translations[]

  @@index([topic_id], map: "posts_topic_index")
  @@index([user_id], map: "posts_user_index")
  @@map("posts")
}

model post_translations {
  post_id      BigInt   @db.BigInt
  locale       String   @db.VarChar(8)
  content_html String   @db.Text
  is_source    Boolean  @default(false)
  version      Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  post posts @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@id([post_id, locale])
  @@index([locale, is_source], map: "post_translations_locale_source_index")
  @@index([post_id, is_source], map: "post_translations_post_source_index")
  @@map("post_translations")
}

model topic_tags {
  topic_id   BigInt   @db.BigInt
  tag_id     BigInt   @db.BigInt
  created_at DateTime @default(now())

  topic topics @relation(fields: [topic_id], references: [id])
  tag   tags   @relation(fields: [tag_id], references: [id])

  @@id([topic_id, tag_id])
  @@index([tag_id], map: "topic_tags_tag_index")
  @@index([topic_id], map: "topic_tags_topic_index")
  @@map("topic_tags")
}

model post_likes {
  post_id    BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  created_at DateTime @default(now())

  post posts @relation("post_likes_post", fields: [post_id], references: [id])
  user users @relation("post_likes_user", fields: [user_id], references: [id])

  @@id([post_id, user_id])
  @@index([user_id], map: "post_likes_user_index")
  @@index([post_id], map: "post_likes_post_index")
  @@map("post_likes")
}

model post_bookmarks {
  post_id    BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  created_at DateTime @default(now())

  post posts @relation("post_bookmarks_post", fields: [post_id], references: [id])
  user users @relation("post_bookmarks_user", fields: [user_id], references: [id])

  @@id([post_id, user_id])
  @@index([user_id], map: "post_bookmarks_user_index")
  @@index([post_id], map: "post_bookmarks_post_index")
  @@map("post_bookmarks")
}

model badges {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  icon          String   @db.VarChar(32)
  badge_type    String   @db.VarChar(32)
  level         Int      @default(1)
  sort          Int      @default(0)
  bg_color      String?  @db.VarChar(16)
  text_color    String?  @db.VarChar(16)
  is_enabled    Boolean  @default(true)
  is_visible    Boolean  @default(true)
  is_deleted    Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  user_badges      user_badges[]        @relation("user_badges_badge")
  users_with_title users[]              @relation("user_title_badge")
  translations     badge_translations[]

  @@index([badge_type], map: "badges_type_index")
  @@index([is_deleted, is_enabled], map: "badges_status_index")
  @@map("badges")
}

model badge_translations {
  badge_id    BigInt   @db.BigInt
  locale      String   @db.VarChar(8)
  name        String   @db.VarChar(32)
  description String?  @db.VarChar(255)
  is_source   Boolean  @default(false)
  version     Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  badge badges @relation(fields: [badge_id], references: [id], onDelete: Cascade)

  @@id([badge_id, locale])
  @@index([locale, is_source], map: "badge_translations_locale_source_index")
  @@index([badge_id, is_source], map: "badge_translations_badge_source_index")
  @@map("badge_translations")
}

model user_badges {
  user_id    BigInt   @db.BigInt
  badge_id   BigInt   @db.BigInt
  awarded_at DateTime @default(now())
  awarded_by BigInt?  @db.BigInt
  is_deleted Boolean  @default(false)

  user    users  @relation("user_badges_user", fields: [user_id], references: [id])
  badge   badges @relation("user_badges_badge", fields: [badge_id], references: [id])
  awarder users? @relation("user_badges_awarder", fields: [awarded_by], references: [id])

  @@id([user_id, badge_id])
  @@index([user_id, is_deleted], map: "user_badges_user_index")
  @@index([badge_id, is_deleted], map: "user_badges_badge_index")
  @@index([is_deleted], map: "user_badges_deleted_index")
  @@map("user_badges")
}

model system_configs {
  id            BigInt   @id @db.BigInt
  config_key    String   @unique @db.VarChar(64)
  config_value  String   @db.Text
  config_type   String   @db.VarChar(16)
  category      String   @db.VarChar(32)
  description   String?  @db.VarChar(255)
  is_public     Boolean  @default(false)
  is_sensitive  Boolean  @default(false)
  default_value String   @db.Text
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@index([category], map: "system_configs_category_index")
  @@index([is_public], map: "system_configs_public_index")
  @@map("system_configs")
}

model user_follows {
  follower_id  BigInt   @db.BigInt
  following_id BigInt   @db.BigInt
  created_at   DateTime @default(now())

  follower  users @relation("user_follows_follower", fields: [follower_id], references: [id])
  following users @relation("user_follows_following", fields: [following_id], references: [id])

  @@id([follower_id, following_id])
  @@index([follower_id], map: "user_follows_follower_index")
  @@index([following_id], map: "user_follows_following_index")
  @@map("user_follows")
}

model conversations {
  id         BigInt   @id @db.BigInt
  user1_id   BigInt   @db.BigInt
  user2_id   BigInt   @db.BigInt
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user1    users      @relation("conversations_user1", fields: [user1_id], references: [id])
  user2    users      @relation("conversations_user2", fields: [user2_id], references: [id])
  messages messages[] @relation("messages_conversation")

  @@index([user1_id], map: "conversations_user1_index")
  @@index([user2_id], map: "conversations_user2_index")
  @@index([user1_id, user2_id], map: "conversations_users_index")
  @@map("conversations")
}

model messages {
  id              BigInt   @id @db.BigInt
  conversation_id BigInt   @db.BigInt
  sender_id       BigInt   @db.BigInt
  content         String   @db.Text
  is_read         Boolean  @default(false)
  is_deleted      Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  conversation conversations @relation("messages_conversation", fields: [conversation_id], references: [id])
  sender       users         @relation("messages_sender", fields: [sender_id], references: [id])

  @@index([conversation_id], map: "messages_conversation_index")
  @@index([sender_id], map: "messages_sender_index")
  @@index([is_read], map: "messages_read_index")
  @@map("messages")
}

model poll_options {
  id          BigInt   @id @db.BigInt
  topic_id    BigInt   @db.BigInt
  option_text String   @db.VarChar(256)
  sort        Int
  is_deleted  Boolean  @default(false)
  created_at  DateTime @default(now())

  topic topics       @relation(fields: [topic_id], references: [id])
  votes poll_votes[]

  @@index([topic_id], map: "poll_options_topic_index")
  @@map("poll_options")
}

model poll_votes {
  option_id  BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  created_at DateTime @default(now())

  option poll_options @relation(fields: [option_id], references: [id])
  user   users        @relation("poll_votes_user", fields: [user_id], references: [id])

  @@id([option_id, user_id])
  @@index([option_id], map: "poll_votes_option_index")
  @@index([user_id], map: "poll_votes_user_index")
  @@map("poll_votes")
}

model lottery_participants {
  topic_id   BigInt   @db.BigInt
  user_id    BigInt   @db.BigInt
  is_winner  Boolean  @default(false)
  created_at DateTime @default(now())

  topic topics @relation(fields: [topic_id], references: [id])
  user  users  @relation("lottery_participants_user", fields: [user_id], references: [id])

  @@id([topic_id, user_id])
  @@index([topic_id], map: "lottery_participants_topic_index")
  @@index([user_id], map: "lottery_participants_user_index")
  @@index([is_winner], map: "lottery_participants_winner_index")
  @@map("lottery_participants")
}

model poll_configs {
  topic_id                 BigInt   @id @db.BigInt
  allow_multiple           Boolean  @default(false)
  max_choices              Int?
  show_results_before_vote Boolean  @default(false)
  show_voter_list          Boolean  @default(false)
  created_at               DateTime @default(now())
  updated_at               DateTime @updatedAt

  topic topics @relation(fields: [topic_id], references: [id])

  @@index([topic_id], map: "poll_configs_topic_index")
  @@map("poll_configs")
}

model lottery_configs {
  topic_id              BigInt    @id @db.BigInt
  draw_type             String    @db.VarChar(32)
  end_time              DateTime?
  participant_threshold Int?
  algorithm_type        String    @db.VarChar(32)
  floor_interval        Int?
  fixed_floors          String?   @db.VarChar(500)
  winner_count          Int?
  entry_cost            Int       @default(0)
  is_drawn              Boolean   @default(false)
  drawn_at              DateTime?
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt

  topic topics @relation(fields: [topic_id], references: [id])

  @@index([draw_type], map: "lottery_configs_drawtype_index")
  @@index([is_drawn], map: "lottery_configs_drawn_index")
  @@index([end_time], map: "lottery_configs_endtime_index")
  @@index([draw_type, is_drawn], map: "lottery_configs_type_drawn_index")
  @@map("lottery_configs")
}

model lottery_winners {
  id           BigInt   @id @db.BigInt
  topic_id     BigInt   @db.BigInt
  post_id      BigInt   @db.BigInt
  user_id      BigInt   @db.BigInt
  floor_number Int
  won_at       DateTime @default(now())
  created_at   DateTime @default(now())

  topic topics @relation(fields: [topic_id], references: [id])
  post  posts  @relation(fields: [post_id], references: [id])
  user  users  @relation("lottery_winners_user", fields: [user_id], references: [id])

  @@unique([topic_id, post_id], map: "lottery_winners_topic_post_unique")
  @@unique([topic_id, user_id], map: "lottery_winners_topic_user_unique")
  @@index([topic_id], map: "lottery_winners_topic_index")
  @@index([user_id], map: "lottery_winners_user_index")
  @@index([won_at], map: "lottery_winners_wonat_index")
  @@map("lottery_winners")
}

model bounty_configs {
  topic_id        BigInt   @id @db.BigInt
  bounty_total    Int
  bounty_type     String   @db.VarChar(32)
  bounty_slots    Int
  remaining_slots Int
  single_amount   Int?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  topic topics @relation(fields: [topic_id], references: [id])

  @@index([bounty_type], map: "bounty_configs_type_index")
  @@map("bounty_configs")
}

model bounty_rewards {
  id          BigInt   @id @db.BigInt
  topic_id    BigInt   @db.BigInt
  post_id     BigInt   @db.BigInt
  giver_id    BigInt   @db.BigInt
  receiver_id BigInt   @db.BigInt
  amount      Int
  created_at  DateTime @default(now())

  topic    topics @relation(fields: [topic_id], references: [id])
  post     posts  @relation(fields: [post_id], references: [id])
  giver    users  @relation("bounty_rewards_giver", fields: [giver_id], references: [id])
  receiver users  @relation("bounty_rewards_receiver", fields: [receiver_id], references: [id])

  @@unique([topic_id, receiver_id], map: "bounty_rewards_topic_receiver_unique")
  @@index([topic_id], map: "bounty_rewards_topic_index")
  @@index([receiver_id], map: "bounty_rewards_receiver_index")
  @@index([giver_id], map: "bounty_rewards_giver_index")
  @@map("bounty_rewards")
}

model question_acceptances {
  topic_id    BigInt   @id @db.BigInt
  post_id     BigInt   @unique @db.BigInt
  accepted_by BigInt   @db.BigInt
  accepted_at DateTime @default(now())
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  topic    topics @relation(fields: [topic_id], references: [id])
  post     posts  @relation(fields: [post_id], references: [id])
  accepter users  @relation("question_acceptances_accepter", fields: [accepted_by], references: [id])

  @@index([post_id], map: "question_acceptances_post_index")
  @@index([accepted_by], map: "question_acceptances_accepter_index")
  @@map("question_acceptances")
}

model user_checkins {
  id             BigInt   @id @db.BigInt
  user_id        BigInt   @db.BigInt
  checkin_date   DateTime @db.Date
  credits_earned Int      @default(0)
  created_at     DateTime @default(now())

  user users @relation("user_checkins_user", fields: [user_id], references: [id])

  @@unique([user_id, checkin_date], map: "user_checkins_user_date_unique")
  @@index([user_id], map: "user_checkins_user_index")
  @@index([checkin_date], map: "user_checkins_date_index")
  @@index([created_at], map: "user_checkins_created_index")
  @@map("user_checkins")
}

model user_login_stats {
  user_id                BigInt   @id @db.BigInt
  last_login_at          DateTime @default(now())
  last_login_ip          String   @db.VarChar(64)
  consecutive_login_days Int      @default(0)
  total_login_days       Int      @default(1)
  location_lat           String?  @db.VarChar(32)
  location_long          String?  @db.VarChar(32)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_login_stats")
}

model user_login_logs {
  id            BigInt   @id @db.BigInt
  user_id       BigInt?  @db.BigInt
  ip            String   @db.VarChar(64)
  user_agent    String?  @db.VarChar(512)
  location_lat  String?  @db.VarChar(32)
  location_long String?  @db.VarChar(32)
  status        String   @db.VarChar(16) // SUCCESS, FAILED
  login_method  String   @db.VarChar(32) // FORM, GITHUB, GOOGLE, LINUXDO, etc.
  login_at      DateTime @default(now())

  user users? @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id], map: "user_login_logs_user_index")
  @@index([login_at], map: "user_login_logs_time_index")
  @@index([status], map: "user_login_logs_status_index")
  @@map("user_login_logs")
}

enum CreditLogType {
  CHECKIN
  POST_REWARD
  BOUNTY_RECEIVED
  BOUNTY_GIVEN
  LOTTERY_ENTRY
  ADMIN_ADJUSTMENT
  OTHER
}

// æèµ æ¥æºç±»å‹
enum DonationSource {
  KOFI // Ko-fi å¹³å°
  PATREON // Patreon å¹³å°
  PAYPAL // PayPal ç›´æ¥æèµ 
  ALIPAY // æ”¯ä»˜å®
  WECHAT_PAY // å¾®ä¿¡æ”¯ä»˜
  BANK_TRANSFER // é“¶è¡Œè½¬è´¦/çº¿ä¸‹è½¬è´¦
  CRYPTO // åŠ å¯†è´§å¸
  OTHER // å…¶å®ƒæ¥æº
}

// æèµ çŠ¶æ€
enum DonationStatus {
  PENDING // å¾…ç¡®è®¤ï¼ˆçº¿ä¸‹è½¬è´¦ç­‰éœ€è¦äººå·¥ç¡®è®¤ï¼‰
  CONFIRMED // å·²ç¡®è®¤
  FAILED // å¤±è´¥/æ— æ•ˆ
  REFUNDED // å·²é€€æ¬¾
  CANCELLED // å·²å–æ¶ˆ
}

model user_credit_logs {
  id          BigInt        @id @db.BigInt
  user_id     BigInt        @db.BigInt
  amount      Int
  balance     Int
  type        CreditLogType
  description String        @default("") @db.VarChar(256)
  created_at  DateTime      @default(now())

  user users @relation("user_credit_logs_user", fields: [user_id], references: [id])

  @@index([user_id], map: "user_credit_logs_user_index")
  @@index([type], map: "user_credit_logs_type_index")
  @@index([created_at], map: "user_credit_logs_created_index")
  @@map("user_credit_logs")
}

// æèµ è®°å½•è¡¨
model donations {
  id BigInt @id @db.BigInt

  // æèµ ç”¨æˆ·ï¼ˆå¯ä¸ºç©ºï¼Œæ”¯æŒéæ³¨å†Œç”¨æˆ·æèµ ï¼‰
  user_id BigInt? @db.BigInt

  // é‡‘é¢ç›¸å…³
  amount   Decimal @db.Decimal(10, 2) // æèµ é‡‘é¢ï¼Œæ”¯æŒå°æ•°
  currency String  @default("CNY") @db.VarChar(8) // è´§å¸ç±»å‹ï¼šCNY, USD, EUR ç­‰

  // æ¥æºåŒºåˆ†
  source DonationSource // æèµ æ¥æº

  // çŠ¶æ€
  status DonationStatus @default(PENDING)

  // å¤–éƒ¨å…³è”IDï¼ˆç”¨äºå¯¹æ¥ç¬¬ä¸‰æ–¹å¹³å°çš„äº¤æ˜“IDï¼‰
  external_id String? @db.VarChar(128)

  // æ˜¯å¦åŒ¿åæèµ 
  is_anonymous Boolean @default(false)

  // æèµ è€…æ˜¾ç¤ºåç§°ï¼ˆç”¨äºéæ³¨å†Œç”¨æˆ·æˆ–åŒ¿åç”¨æˆ·çš„å±•ç¤ºåï¼‰
  donor_name String? @db.VarChar(64)

  // æèµ è€…é‚®ç®±ï¼ˆç”¨äºéæ³¨å†Œç”¨æˆ·è”ç³»æˆ–å‘é€æ„Ÿè°¢ï¼‰
  donor_email String? @db.VarChar(256)

  // æèµ ç•™è¨€
  message String? @db.VarChar(500)

  // ç®¡ç†å‘˜å¤‡æ³¨ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
  admin_note String? @db.VarChar(500)

  // ç¡®è®¤ä¿¡æ¯
  confirmed_by BigInt?   @db.BigInt // ç¡®è®¤äººï¼ˆç®¡ç†å‘˜ï¼‰
  confirmed_at DateTime? // ç¡®è®¤æ—¶é—´

  // é€šç”¨å­—æ®µ
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // å…³è”å…³ç³»
  user      users? @relation("donations_user", fields: [user_id], references: [id])
  confirmer users? @relation("donations_confirmer", fields: [confirmed_by], references: [id])

  @@index([user_id], map: "donations_user_index")
  @@index([source], map: "donations_source_index")
  @@index([status], map: "donations_status_index")
  @@index([external_id], map: "donations_external_index")
  @@index([is_anonymous], map: "donations_anonymous_index")
  @@index([created_at], map: "donations_created_index")
  @@index([status, source], map: "donations_status_source_index")
  @@map("donations")
}

// ==================== è‡ªåŠ¨åŒ–è§„åˆ™ç³»ç»Ÿ ====================

// è§¦å‘å™¨ç±»å‹æšä¸¾
enum RuleTriggerType {
  CRON // å®šæ—¶ä»»åŠ¡
  POST_CREATE // å‘å¸–
  POST_REPLY // å›å¸–
  CHECKIN // ç­¾åˆ°
  DONATION // æèµ 
  POST_LIKE_GIVEN // é€å‡ºçš„èµ
  POST_LIKE_RECEIVED // æ”¶åˆ°çš„èµ
  USER_REGISTER // æ³¨å†Œ
  USER_LOGIN // ç™»å½•
}

// æ‰§è¡ŒåŠ¨ä½œç±»å‹æšä¸¾
enum RuleActionType {
  CREDIT_CHANGE // ç§¯åˆ†å˜åŠ¨
  BADGE_GRANT // æˆäºˆå¾½ç« 
  BADGE_REVOKE // æ’¤é”€å¾½ç« 
  USER_GROUP_CHANGE // ç”¨æˆ·ç»„å˜æ›´ï¼ˆé¢„ç•™ï¼‰
}

// è‡ªåŠ¨åŒ–è§„åˆ™è¡¨
model automation_rules {
  id BigInt @id @db.BigInt

  // è§„åˆ™åŸºæœ¬ä¿¡æ¯
  name        String  @db.VarChar(128) // è§„åˆ™åç§°
  description String? @db.VarChar(512) // è§„åˆ™æè¿°

  // è§¦å‘å™¨é…ç½®
  trigger_type       RuleTriggerType // è§¦å‘å™¨ç±»å‹
  trigger_conditions Json? // è§¦å‘æ¡ä»¶ï¼ˆJSONæ ¼å¼å­˜å‚¨åŠ¨æ€é…ç½®ï¼‰
  // ç¤ºä¾‹:
  // CRON: {"cron": "0 0 * * *", "timezone": "Asia/Shanghai"}
  // POST_CREATE: {"category_ids": [1,2,3], "min_content_length": 100}
  // POST_REPLY: {"topic_type": "BOUNTY", "is_first_reply": true}
  // CHECKIN: {"consecutive_days": 7}
  // DONATION: {"min_amount": 100, "currency": "CNY", "sources": ["ALIPAY", "WECHAT_PAY"]}
  // POST_LIKE_GIVEN: {"min_count": 10}
  //   - min_count: ç”¨æˆ·é€å‡ºçš„èµè¾¾åˆ°æ­¤æ•°é‡æ‰è§¦å‘
  // POST_LIKE_RECEIVED: {"min_count": 10}
  //   - min_count: ç”¨æˆ·æ”¶åˆ°çš„èµè¾¾åˆ°æ­¤æ•°é‡æ‰è§¦å‘
  // USER_REGISTER: {"oauth_provider": "github"}
  // USER_LOGIN: {"consecutive_days": 30}

  // æ‰§è¡ŒåŠ¨ä½œé…ç½®ï¼ˆæ”¯æŒå¤šä¸ªåŠ¨ä½œï¼‰
  actions Json // åŠ¨ä½œåˆ—è¡¨ï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰
  // ç¤ºä¾‹:
  // [
  //   {"type": "CREDIT_CHANGE", "params": {"amount": 10, "description": "æ¯æ—¥ç­¾åˆ°å¥–åŠ±"}},
  //   {"type": "BADGE_GRANT", "params": {"badge_id": 5, "auto_grant": true}},
  //   {"type": "BADGE_REVOKE", "params": {"badge_id": 3, "reason": "æ¡ä»¶ä¸æ»¡è¶³"}}
  // ]
  // æ¯ä¸ª action å¯¹è±¡åŒ…å«:
  // - type: åŠ¨ä½œç±»å‹å­—ç¬¦ä¸² ("CREDIT_CHANGE" | "BADGE_GRANT" | "BADGE_REVOKE" | "USER_GROUP_CHANGE")
  // - params: åŠ¨ä½œå‚æ•°å¯¹è±¡

  // è§„åˆ™æ§åˆ¶
  priority         Int     @default(0) // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
  is_enabled       Boolean @default(true) // æ˜¯å¦å¯ç”¨
  is_repeatable    Boolean @default(true) // æ˜¯å¦å¯é‡å¤è§¦å‘
  max_executions   Int? // æœ€å¤§æ‰§è¡Œæ¬¡æ•°ï¼ˆnullè¡¨ç¤ºæ— é™åˆ¶ï¼‰
  cooldown_seconds Int? // å†·å´æ—¶é—´ï¼ˆç§’ï¼‰

  // æ—¶é—´é™åˆ¶
  start_time DateTime? // è§„åˆ™ç”Ÿæ•ˆå¼€å§‹æ—¶é—´
  end_time   DateTime? // è§„åˆ™ç”Ÿæ•ˆç»“æŸæ—¶é—´

  // å®¡è®¡å­—æ®µ
  created_by BigInt?  @db.BigInt // åˆ›å»ºäººï¼ˆç®¡ç†å‘˜IDï¼‰
  updated_by BigInt?  @db.BigInt // æœ€åæ›´æ–°äºº
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // å…³è”å…³ç³»
  execution_logs automation_rule_logs[]

  @@index([trigger_type], map: "automation_rules_trigger_index")
  @@index([is_enabled, is_deleted], map: "automation_rules_status_index")
  @@index([trigger_type, is_enabled], map: "automation_rules_trigger_enabled_index")
  @@index([priority], map: "automation_rules_priority_index")
  @@index([start_time, end_time], map: "automation_rules_time_range_index")
  @@map("automation_rules")
}

// è§„åˆ™æ‰§è¡Œæ—¥å¿—è¡¨
model automation_rule_logs {
  id BigInt @id @db.BigInt

  // å…³è”è§„åˆ™
  rule_id BigInt @db.BigInt

  // è§¦å‘ä¿¡æ¯
  triggered_by    BigInt? @db.BigInt // è§¦å‘ç”¨æˆ·ID(å¯ä¸ºç©º,å¦‚å®šæ—¶ä»»åŠ¡)
  target_user_id  BigInt? @db.BigInt // æ‰§è¡Œå¯¹è±¡çš„ç”¨æˆ·ID(å¦‚æˆäºˆå¾½ç« çš„ç›®æ ‡ç”¨æˆ·)
  trigger_context Json? // è§¦å‘ä¸Šä¸‹æ–‡æ•°æ®
  // ç¤ºä¾‹:
  // {"topic_id": 123, "post_id": 456, "category_id": 1}
  // {"donation_id": 789, "amount": 500}
  // {"checkin_id": 111, "consecutive_days": 7}

  // æ‰§è¡Œç»“æœ
  execution_status String @db.VarChar(32) // SUCCESS, FAILED, SKIPPED (æŒ‰ä¼˜å…ˆçº§: FAILED > SKIPPED > SUCCESS)
  execution_result Json? // æ‰§è¡Œç»“æœè¯¦æƒ…(èšåˆæ‰€æœ‰åŠ¨ä½œçš„ç»“æœ)
  // æ ¼å¼ç¤ºä¾‹(ä¸€æ¬¡è§„åˆ™æ‰§è¡Œè®°å½•ä¸€æ¡æ—¥å¿—ï¼ŒåŒ…å«æ‰€æœ‰åŠ¨ä½œç»“æœ):
  // [
  //   {"actionType": "CREDIT_CHANGE", "status": "SUCCESS", "data": {"credit_changed": 10, "new_balance": 1000}},
  //   {"actionType": "BADGE_GRANT", "status": "SKIPPED", "message": "Automation.skipReason.badgeAlreadyOwned", "messageParams": {"badgeName": "æ´»è·ƒç”¨æˆ·"}}
  // ]
  // æ¯ä¸ª actionResult åŒ…å«:
  // - actionType: RuleActionType æšä¸¾å€¼
  // - status: åŠ¨ä½œæ‰§è¡ŒçŠ¶æ€ (SUCCESS/FAILED/SKIPPED)
  // - data: æˆåŠŸæ‰§è¡Œçš„æ•°æ®
  // - message: å¤±è´¥/è·³è¿‡çš„å¤šè¯­è¨€é”®å€¼
  // - messageParams: å¤±è´¥/è·³è¿‡æ¶ˆæ¯çš„å‚æ•°

  error_message String? @db.Text // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰

  // æ‰§è¡Œæ—¶é—´
  executed_at DateTime @default(now())
  created_at  DateTime @default(now())

  // å…³è”å…³ç³»
  rule automation_rules @relation(fields: [rule_id], references: [id])

  @@index([rule_id], map: "automation_logs_rule_index")
  @@index([triggered_by], map: "automation_logs_user_index")
  @@index([target_user_id], map: "automation_logs_target_index")
  @@index([execution_status], map: "automation_logs_status_index")
  @@index([executed_at], map: "automation_logs_executed_index")
  @@index([rule_id, execution_status], map: "automation_logs_rule_status_index")
  @@index([rule_id, target_user_id], map: "automation_logs_rule_target_index") // ä¼˜åŒ–ï¼šæ”¯æŒä¸å¯é‡å¤æ£€æŸ¥
  @@index([rule_id, target_user_id, execution_status], map: "automation_logs_rule_target_status_index")
  @@index([triggered_by, executed_at], map: "automation_logs_user_time_index")
  @@map("automation_rule_logs")
}

// ==================== ç¿»è¯‘ä»»åŠ¡ç³»ç»Ÿ ====================

// ç¿»è¯‘å®ä½“ç±»å‹æšä¸¾
enum TranslationEntityType {
  CATEGORY // åˆ†ç±»
  TAG // æ ‡ç­¾
  BADGE // å¾½ç« 
  TOPIC // è¯é¢˜
  POST // å¸–å­
  EXPRESSION_GROUP // è¡¨æƒ…åˆ†ç»„
  EXPRESSION // è¡¨æƒ…
}

// ç¿»è¯‘ä»»åŠ¡çŠ¶æ€æšä¸¾
enum TranslationTaskStatus {
  PENDING // å¾…å¤„ç†
  PROCESSING // å¤„ç†ä¸­
  COMPLETED // å·²å®Œæˆ
  FAILED // å¤±è´¥
  CANCELLED // å·²å–æ¶ˆ
}

// ç¿»è¯‘ä»»åŠ¡ä¼˜å…ˆçº§æšä¸¾
enum TranslationTaskPriority {
  LOWEST // æœ€ä½ä¼˜å…ˆçº§
  LOW // ä½ä¼˜å…ˆçº§
  NORMAL // æ™®é€šä¼˜å…ˆçº§
  HIGH // é«˜ä¼˜å…ˆçº§
  URGENT // ç´§æ€¥ä¼˜å…ˆçº§
}

// ç¿»è¯‘ä»»åŠ¡è¡¨
model translation_tasks {
  id BigInt @id @db.BigInt

  // ç›®æ ‡å®ä½“ä¿¡æ¯
  entity_type TranslationEntityType // å®ä½“ç±»å‹
  entity_id   BigInt                @db.BigInt // ç›®æ ‡å®ä½“ID

  // ç¿»è¯‘é…ç½®
  source_locale  String @db.VarChar(8) // æºè¯­è¨€ä»£ç 
  target_locale  String @db.VarChar(8) // ç›®æ ‡è¯­è¨€ä»£ç 
  source_version Int    @default(1) // æºå†…å®¹ç‰ˆæœ¬å·

  // ä»»åŠ¡çŠ¶æ€
  status   TranslationTaskStatus   @default(PENDING) // ä»»åŠ¡çŠ¶æ€
  priority TranslationTaskPriority @default(NORMAL) // ä»»åŠ¡ä¼˜å…ˆçº§

  // é‡è¯•æœºåˆ¶
  retry_count   Int     @default(0) // é‡è¯•æ¬¡æ•°
  error_message String? @db.Text // é”™è¯¯ä¿¡æ¯

  // æ—¶é—´è¿½è¸ª
  started_at   DateTime? // å¼€å§‹å¤„ç†æ—¶é—´
  completed_at DateTime? // å®Œæˆæ—¶é—´
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  // å¤åˆç´¢å¼•ï¼šæŒ‰çŠ¶æ€å’Œä¼˜å…ˆçº§æŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡(ç”¨äºä»»åŠ¡é˜Ÿåˆ—)
  @@index([status, priority], map: "translation_tasks_status_priority_index")
  // å¤åˆç´¢å¼•ï¼šæŸ¥è¯¢ç‰¹å®šå®ä½“çš„æ‰€æœ‰ç¿»è¯‘ä»»åŠ¡
  @@index([entity_type, entity_id], map: "translation_tasks_entity_index")
  // å¤åˆç´¢å¼•ï¼šæŸ¥è¯¢ç‰¹å®šå®ä½“å’Œè¯­è¨€çš„ä»»åŠ¡(é¿å…é‡å¤åˆ›å»º)
  @@index([entity_type, entity_id, target_locale], map: "translation_tasks_entity_locale_index")
  @@map("translation_tasks")
}

enum NotificationType {
  SYSTEM // System announcement
  TOPIC_REPLY // Someone replied to your topic
  POST_REPLY // Someone replied to your post
  MENTION // Someone @mentioned you
  LIKE // Someone liked your post
  BADGE_AWARD // You received a badge
  BOUNTY_REWARD // You received a bounty reward
  LOTTERY_WIN // You won a lottery
}

model notifications {
  id         BigInt           @id @db.BigInt
  user_id    BigInt           @db.BigInt // Recipient
  sender_id  BigInt           @db.BigInt // Triggered by (e.g., the person who replied)
  type       NotificationType
  read       Boolean          @default(false)
  is_deleted Boolean          @default(false)

  // Context References
  topic_id BigInt? @db.BigInt
  post_id  BigInt? @db.BigInt

  // Flexible data for other types (e.g., badge_id, system message content)
  data Json?

  created_at DateTime @default(now())

  // Relations
  user   users   @relation("notifications_user", fields: [user_id], references: [id])
  sender users?  @relation("notifications_sender", fields: [sender_id], references: [id])
  topic  topics? @relation(fields: [topic_id], references: [id])
  post   posts?  @relation(fields: [post_id], references: [id])

  // Indexes for performance
  @@index([user_id], map: "notifications_user_index")
  @@index([read], map: "notifications_read_index")
  @@index([type], map: "notifications_type_index")
  @@index([created_at], map: "notifications_created_index")
  // Composite index for fetching unread notifications efficiently
  @@index([user_id, read, created_at], map: "notifications_user_read_created_index")
  @@map("notifications")
}

model uploads {
  id           BigInt   @id @db.BigInt
  user_id      BigInt   @db.BigInt
  url          String   @db.VarChar(255)
  pathname     String   @db.VarChar(255)
  content_type String   @db.VarChar(64)
  size         Int
  created_at   DateTime @default(now())

  user users @relation(fields: [user_id], references: [id])

  @@index([user_id], map: "uploads_user_index")
  @@index([created_at], map: "uploads_created_index")
  @@map("uploads")
}

enum LLMInterfaceMode {
  OPENAI
  GEMINI
  DEEPSEEK
  ANTHROPIC
  GROK
}

enum LLMUsage {
  TRANSLATION
  CHAT
  SUMMARIZATION
}

model llm_configs {
  id             BigInt           @id @default(autoincrement()) @db.BigInt
  interface_mode LLMInterfaceMode
  name           String           @db.VarChar(100)
  base_url       String?          @db.VarChar(255)
  api_key        String           @db.VarChar(255)
  usage          LLMUsage         @unique
  is_enabled     Boolean          @default(true)
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @updatedAt @db.Timestamptz(6)
}

// ç”¨æˆ·è‡ªå®šä¹‰çŠ¶æ€è¡¨
model user_custom_statuses {
  user_id     BigInt    @id @db.BigInt // ç”¨æˆ·ID,ä½œä¸ºä¸»é”®ä¿è¯ä¸€å¯¹ä¸€å…³ç³»
  emoji       String?   @db.VarChar(16) // emoji è¡¨æƒ…(å¯ä¸ºç©º,æ”¯æŒä»…æ–‡æœ¬çŠ¶æ€)
  status_text String    @db.VarChar(100) // çŠ¶æ€æè¿°æ–‡æœ¬
  expires_at  DateTime? // è‡ªåŠ¨ç§»é™¤çŠ¶æ€çš„æ—¶é—´(å¯ä¸ºç©º,è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ)
  is_deleted  Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  // å…³è”å…³ç³»
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at], map: "user_custom_statuses_expires_index") // ç”¨äºå®šæ—¶æ¸…ç†è¿‡æœŸçŠ¶æ€
  @@index([is_deleted], map: "user_custom_statuses_deleted_index")
  @@map("user_custom_statuses")
}

model social_providers {
  id             BigInt   @id @db.BigInt
  provider_key   String   @unique @db.VarChar(32)
  name           String   @db.VarChar(64)
  client_id      String   @db.VarChar(256)
  client_secret  String   @db.VarChar(256)
  authorize_url  String?  @db.VarChar(512)
  token_url      String?  @db.VarChar(512)
  userinfo_url   String?  @db.VarChar(512)
  well_known_url String?  @db.VarChar(512)
  scope          String?  @db.VarChar(256)
  icon           String?  @db.VarChar(512)
  sort           Int      @default(0)
  is_enabled     Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user_accounts user_social_accounts[] @relation("user_social_accounts_provider")

  @@index([is_enabled], map: "social_providers_enabled_index")
  @@map("social_providers")
}

model user_social_accounts {
  id                BigInt    @id @db.BigInt
  user_id           BigInt    @db.BigInt
  provider_key      String    @db.VarChar(32)
  provider_uid      String    @db.VarChar(128)
  provider_username String?   @db.VarChar(128)
  provider_email    String?   @db.VarChar(256)
  provider_avatar   String?   @db.VarChar(512)
  access_token      String?   @db.VarChar(2048)
  refresh_token     String?   @db.VarChar(2048)
  token_expires_at  DateTime?
  extra_data        Json?
  last_used_at      DateTime?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  user     users            @relation("user_social_accounts_user", fields: [user_id], references: [id])
  provider social_providers @relation("user_social_accounts_provider", fields: [provider_key], references: [provider_key])

  @@unique([provider_key, provider_uid], map: "user_social_accounts_provider_uid_unique")
  @@index([user_id], map: "user_social_accounts_user_index")
  @@index([provider_key], map: "user_social_accounts_provider_index")
  @@map("user_social_accounts")
}

model seed_migrations {
  version    Int      @id
  name       String   @db.VarChar(128)
  applied_at DateTime @default(now())

  @@map("seed_migrations")
}

model user_two_factor {
  user_id      BigInt    @id @db.BigInt
  secret       String    @db.VarChar(256) // Base32 encoded secret
  is_enabled   Boolean   @default(false)
  backup_codes Json? // Encrypted backup codes
  enabled_at   DateTime?
  last_used_at DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_two_factor")
}

// ==================== è¡¨æƒ…ç³»ç»Ÿ ====================

enum ExpressionType {
  IMAGE
  TEXT
}

model expression_groups {
  id            BigInt   @id @db.BigInt
  source_locale String   @default("zh") @db.VarChar(8)
  code          String   @unique @db.VarChar(32) // e.g. "default", "onion"
  icon_id       BigInt?  @db.BigInt // Reference to expression ID for group icon
  sort          Int      @default(0)
  is_enabled    Boolean  @default(true)
  is_deleted    Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  icon_expression expressions?                    @relation("GroupIcon", fields: [icon_id], references: [id], onDelete: SetNull)
  expressions     expressions[]                   @relation("GroupExpressions")
  translations    expression_group_translations[]

  @@map("expression_groups")
}

model expression_group_translations {
  group_id   BigInt   @db.BigInt
  locale     String   @db.VarChar(8)
  name       String   @db.VarChar(32)
  is_source  Boolean  @default(false)
  version    Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  group expression_groups @relation(fields: [group_id], references: [id], onDelete: Cascade)

  @@id([group_id, locale])
  @@index([locale, is_source], map: "expression_group_trans_locale_source_index")
  @@index([group_id, is_source], map: "expression_group_trans_group_source_index")
  @@map("expression_group_translations")
}

model expressions {
  id            BigInt         @id @db.BigInt
  group_id      BigInt         @db.BigInt
  source_locale String         @default("zh") @db.VarChar(8)
  type          ExpressionType @default(IMAGE)
  code          String         @db.VarChar(32) // e.g. "smile", "001"
  image_path    String?        @db.VarChar(256) // e.g. "onion/001.gif"
  text_content  String?        @db.VarChar(64) // e.g. "ğŸ˜Š"
  width         Int?
  height        Int?
  sort          Int            @default(0)
  is_enabled    Boolean        @default(true)
  is_deleted    Boolean        @default(false)
  is_animated   Boolean        @default(false) // æ˜¯å¦ä¸ºåŠ¨ç”»è¡¨æƒ…
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt

  group              expression_groups         @relation("GroupExpressions", fields: [group_id], references: [id])
  translations       expression_translations[]
  used_as_group_icon expression_groups[]       @relation("GroupIcon")

  @@unique([group_id, code], map: "expressions_group_code_unique")
  @@index([group_id], map: "expressions_group_index")
  @@map("expressions")
}

model expression_translations {
  expression_id BigInt   @db.BigInt
  locale        String   @db.VarChar(8)
  name          String   @db.VarChar(64) // e.g. "Smile"
  is_source     Boolean  @default(false)
  version       Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  expression expressions @relation(fields: [expression_id], references: [id], onDelete: Cascade)

  @@id([expression_id, locale])
  @@index([locale, is_source], map: "expression_trans_locale_source_index")
  @@index([expression_id, is_source], map: "expression_trans_expression_source_index")
  @@map("expression_translations")
}

// ==================== å¯¹è±¡å­˜å‚¨ç³»ç»Ÿ ====================

// å­˜å‚¨ä¾›åº”å•†ç±»å‹æšä¸¾
enum StorageProviderType {
  LOCAL // æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
  VERCEL_BLOB // Vercel Blob å­˜å‚¨
  ALIYUN_OSS // é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨
  AWS_S3 // AWS S3 å¯¹è±¡å­˜å‚¨
  TENCENT_COS // è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨
  QINIU // ä¸ƒç‰›äº‘å­˜å‚¨
  UPYUN // åˆæ‹äº‘å­˜å‚¨
  MINIO // MinIO å¯¹è±¡å­˜å‚¨
}

// å­˜å‚¨æ–‡ä»¶å¼•ç”¨ç±»å‹æšä¸¾
enum StorageReferenceType {
  POST // å¸–å­é™„ä»¶
  AVATAR // ç”¨æˆ·å¤´åƒ
  EXPRESSION // è¡¨æƒ…å›¾ç‰‡
  SITE // ç«™ç‚¹ç›¸å…³èµ„æºï¼ˆå¦‚logoã€faviconç­‰ï¼‰
  OTHER // å…¶ä»–èµ„æº
}

// å­˜å‚¨ä¾›åº”å•†é…ç½®è¡¨
model storage_providers {
  id BigInt @id @db.BigInt

  // ä¾›åº”å•†åŸºæœ¬ä¿¡æ¯
  name          String              @db.VarChar(64) // ä¾›åº”å•†åç§°ï¼Œå¦‚ "é»˜è®¤ OSS"
  provider_type StorageProviderType // ä¾›åº”å•†ç±»å‹

  // ä¾›åº”å•†é…ç½®ï¼ˆJSONæ ¼å¼å­˜å‚¨ä¸åŒä¾›åº”å•†çš„é…ç½®å‚æ•°ï¼‰
  config Json
  // LOCAL: {"base_path": "/uploads"}
  // VERCEL_BLOB: {"token": "vercel_blob_xxx"}
  // ALIYUN_OSS: {"access_key_id": "xxx", "access_key_secret": "xxx", "region": "oss-cn-shanghai", "bucket": "my-bucket", "endpoint": "oss-cn-shanghai.aliyuncs.com"}
  // AWS_S3: {"access_key_id": "xxx", "secret_access_key": "xxx", "region": "us-east-1", "bucket": "my-bucket"}
  // TENCENT_COS: {"secret_id": "xxx", "secret_key": "xxx", "region": "ap-shanghai", "bucket": "my-bucket"}
  // QINIU: {"access_key": "xxx", "secret_key": "xxx", "bucket": "my-bucket"}
  // UPYUN: {"operator": "xxx", "password": "xxx", "bucket": "my-bucket"}
  // MINIO: {"endpoint": "minio.example.com", "port": 9000, "access_key": "xxx", "secret_key": "xxx", "bucket": "my-bucket", "use_ssl": true}

  // æ–‡ä»¶è®¿é—®åŸºç¡€åœ°å€ï¼ˆç”¨äºç”Ÿæˆæ–‡ä»¶è®¿é—®URLï¼‰
  base_url String @db.VarChar(512) // å¦‚ "https://cdn.example.com" æˆ– "https://example.com/uploads"

  // ä¾›åº”å•†æ§åˆ¶
  is_default Boolean @default(false) // æ˜¯å¦ä¸ºé»˜è®¤ä¾›åº”å•†ï¼ˆå…¨å±€åªèƒ½æœ‰ä¸€ä¸ªé»˜è®¤ï¼‰
  is_active  Boolean @default(true) // æ˜¯å¦å¯ç”¨
  sort       Int     @default(0) // æ’åºï¼ˆæ•°å­—è¶Šå°è¶Šé å‰ï¼‰

  // é…é¢é™åˆ¶ï¼ˆå¯é€‰ï¼‰
  max_file_size BigInt? @db.BigInt // æœ€å¤§å•æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œnull è¡¨ç¤ºæ— é™åˆ¶
  allowed_types String? @db.VarChar(512) // å…è®¸çš„ MIME ç±»å‹ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼Œnull è¡¨ç¤ºä¸é™åˆ¶ï¼Œå¦‚ "image/*,video/mp4"

  // å®¡è®¡å­—æ®µ
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // å…³è”å…³ç³»
  storage_files storage_files[]

  @@index([provider_type], map: "storage_providers_type_index")
  @@index([is_active, is_deleted], map: "storage_providers_status_index")
  @@index([is_default, is_active], map: "storage_providers_default_index")
  @@map("storage_providers")
}

// æ–‡ä»¶å­˜å‚¨è®°å½•è¡¨
model storage_files {
  id BigInt @id @db.BigInt

  // ä¾›åº”å•†å’Œç”¨æˆ·å…³è”
  provider_id BigInt @db.BigInt // å­˜å‚¨ä¾›åº”å•†ID
  user_id     BigInt @db.BigInt // ä¸Šä¼ ç”¨æˆ·ID

  // æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
  original_filename String @db.VarChar(256) // åŸå§‹æ–‡ä»¶å
  mime_type         String @db.VarChar(128) // MIME ç±»å‹ï¼Œå¦‚ "image/jpeg"
  file_size         BigInt @db.BigInt // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰

  // å­˜å‚¨ä½ç½®ä¿¡æ¯
  storage_key String @db.VarChar(512) // åœ¨ä¾›åº”å•†å¤„çš„å­˜å‚¨é”®/è·¯å¾„ï¼Œå¦‚ "uploads/2024/01/abc123.jpg"

  // æ–‡ä»¶å…ƒæ•°æ®
  metadata Json? // é¢å¤–çš„å…ƒä¿¡æ¯ï¼ˆJSONæ ¼å¼ï¼‰
  // ç¤ºä¾‹:
  // å›¾ç‰‡: {"width": 1920, "height": 1080, "format": "jpeg"}
  // è§†é¢‘: {"duration": 120, "width": 1920, "height": 1080, "codec": "h264"}
  // æ–‡æ¡£: {"pages": 10, "author": "John Doe"}

  // æ–‡ä»¶å“ˆå¸Œå’Œå»é‡
  file_hash String @db.VarChar(128) // æ–‡ä»¶å“ˆå¸Œå€¼ï¼ˆç”¨äºå»é‡æ£€æµ‹ï¼Œå¦‚ MD5/SHA256ï¼‰

  // è®¿é—®æ§åˆ¶
  is_public Boolean @default(true) // æ˜¯å¦å…¬å¼€è®¿é—®

  // ä½¿ç”¨è¿½è¸ªï¼ˆå¯é€‰ï¼Œç”¨äºç»Ÿè®¡å’Œæ¸…ç†æœªä½¿ç”¨æ–‡ä»¶ï¼‰
  reference_type StorageReferenceType // å¼•ç”¨ç±»å‹

  // å®¡è®¡å­—æ®µ
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // å…³è”å…³ç³»
  provider storage_providers @relation(fields: [provider_id], references: [id])
  user     users             @relation("storage_files_user", fields: [user_id], references: [id])

  @@index([provider_id], map: "storage_files_provider_index")
  @@index([user_id], map: "storage_files_user_index")
  @@index([mime_type], map: "storage_files_mime_index")
  @@index([file_hash], map: "storage_files_hash_index")
  @@index([reference_type], map: "storage_files_reference_index")
  @@index([is_deleted, created_at], map: "storage_files_deleted_created_index")
  @@index([created_at], map: "storage_files_created_index")
  @@map("storage_files")
}
